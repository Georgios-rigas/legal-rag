trigger:
  branches:
    include:
    - main
    - master
  paths:
    include:
    - frontend/**
    - azure-pipelines-frontend.yml

variables:
  acrName: 'legalragpersonalacr'
  imageName: 'legal-rag-frontend'
  resourceGroup: 'legal-rag-personal-rg'
  aksCluster: 'legal-rag-personal-aks'
  dockerfilePath: '$(Build.SourcesDirectory)/frontend/Dockerfile.simple'
  azureSubscription: 'Azure-Personal-SC'  # Service connection name - you'll create this

pool:
  name: 'Default'  # Self-hosted Windows agent

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildJob
    displayName: 'Build and Push Image'
    steps:
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '18.x'

    - task: PowerShell@2
      displayName: 'Build React App'
      inputs:
        targetType: 'inline'
        workingDirectory: '$(Build.SourcesDirectory)/frontend'
        script: |
          npm install
          npm run build

    - task: AzureCLI@2
      displayName: 'Login to ACR'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          chcp 65001
          az acr login --name $(acrName)

    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: 'build'
        Dockerfile: '$(dockerfilePath)'
        workingDirectory: '$(Build.SourcesDirectory)/frontend'
        tags: |
          $(Build.BuildId)
          latest
        arguments: '-t $(acrName).azurecr.io/$(imageName):$(Build.BuildId) -t $(acrName).azurecr.io/$(imageName):latest'

    - task: AzureCLI@2
      displayName: 'Push to ACR'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          docker push $(acrName).azurecr.io/$(imageName):$(Build.BuildId)
          docker push $(acrName).azurecr.io/$(imageName):latest

    - task: PowerShell@2
      displayName: 'Cleanup After Push'
      condition: always()
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "Cleaning up frontend images..."
          docker rmi -f $(acrName).azurecr.io/$(imageName):$(Build.BuildId) 2>$null
          docker rmi -f $(acrName).azurecr.io/$(imageName):latest 2>$null
          docker image prune -f

- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployJob
    displayName: 'Deploy to AKS'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy to AKS'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Get AKS credentials
                az aks get-credentials `
                  --resource-group $(resourceGroup) `
                  --name $(aksCluster) `
                  --overwrite-existing

                # Update deployment image
                kubectl set image deployment/legal-rag-frontend `
                  frontend=$(acrName).azurecr.io/$(imageName):$(Build.BuildId)

                # Wait for rollout to complete
                kubectl rollout status deployment/legal-rag-frontend --timeout=5m

                # Show pod status
                kubectl get pods -l app=legal-rag-frontend
