# Legal RAG System Architecture Diagrams

## 1. System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                             USER BROWSER                                 │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 │ HTTP Request
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    AZURE KUBERNETES SERVICE (AKS)                        │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  FRONTEND (React + Nginx)                                        │   │
│  │  ┌────────────────┐                                              │   │
│  │  │ LoadBalancer   │  External IP: 52.166.46.37                   │   │
│  │  │ Service        │                                              │   │
│  │  └───────┬────────┘                                              │   │
│  │          │                                                        │   │
│  │          ▼                                                        │   │
│  │  ┌────────────────┐                                              │   │
│  │  │  Frontend Pod  │                                              │   │
│  │  │  Port: 80      │                                              │   │
│  │  │  Image: ACR    │                                              │   │
│  │  └────────────────┘                                              │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                 │                                        │
│                                 │ API Calls                              │
│                                 ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  BACKEND API (FastAPI + Python)                                  │   │
│  │  ┌────────────────┐                                              │   │
│  │  │ LoadBalancer   │  External IP: 20.50.147.24                   │   │
│  │  │ Service        │                                              │   │
│  │  └───────┬────────┘                                              │   │
│  │          │                                                        │   │
│  │          ▼                                                        │   │
│  │  ┌────────────────┐                                              │   │
│  │  │  Backend Pod   │                                              │   │
│  │  │  Port: 8000    │                                              │   │
│  │  │  Image: ACR    │                                              │   │
│  │  │                │                                              │   │
│  │  │  Environment:  │                                              │   │
│  │  │  - EMBEDDING   │                                              │   │
│  │  │    PROVIDER    │                                              │   │
│  │  │  - API KEYS    │                                              │   │
│  │  └────────────────┘                                              │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  KUBERNETES SECRETS                                              │   │
│  │  ┌────────────────────────────────────────────────────────────┐  │   │
│  │  │ - PINECONE_API_KEY                                         │  │   │
│  │  │ - ANTHROPIC_API_KEY                                        │  │   │
│  │  │ - OPENAI_API_KEY                                           │  │   │
│  │  │ - AWS_ACCESS_KEY_ID                                        │  │   │
│  │  │ - AWS_SECRET_ACCESS_KEY                                    │  │   │
│  │  └────────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                 │                    │                    │
                 │                    │                    │
        ┌────────▼────────┐  ┌────────▼────────┐  ┌───────▼────────┐
        │   PINECONE      │  │   ANTHROPIC     │  │   OPENAI       │
        │  Vector DB      │  │   Claude API    │  │  Embeddings    │
        │                 │  │                 │  │                │
        │  Index:         │  │  Model:         │  │  Model:        │
        │  legal-cases    │  │  sonnet-4-5     │  │  text-embed-   │
        │                 │  │                 │  │  3-small       │
        │  Vectors:       │  │  Purpose:       │  │                │
        │  9,594          │  │  Answer         │  │  Purpose:      │
        │                 │  │  Generation     │  │  Query         │
        │  Dim: 1536      │  │                 │  │  Embedding     │
        └─────────────────┘  └─────────────────┘  └────────────────┘
                 │
                 │
        ┌────────▼────────┐
        │   AWS S3        │
        │   PDF Storage   │
        │                 │
        │  Bucket:        │
        │  legal-cases-   │
        │  raw            │
        │                 │
        │  Files: 1,571   │
        │  PDFs           │
        └─────────────────┘
```

## 2. CI/CD Pipeline Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          DEVELOPMENT                                     │
└─────────────────────────────────────────────────────────────────────────┘

    Developer                  Git Repository              Azure DevOps
       │                            │                            │
       │  1. Make changes           │                            │
       │  ─────────────►            │                            │
       │                            │                            │
       │  2. git commit             │                            │
       │  ─────────────►            │                            │
       │                            │                            │
       │  3. git push               │                            │
       │  ──────────────────────────┼───────────────►            │
       │                            │                            │
       │                            │   4. Webhook triggers      │
       │                            │      pipeline              │
       │                            │   ─────────────────►       │
       │                            │                            │

┌─────────────────────────────────────────────────────────────────────────┐
│                       BACKEND CI/CD PIPELINE                             │
│                      (azure-pipelines-backend.yml)                       │
└─────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────────────────────────────────────────────────────┐
  │  STAGE 1: BUILD AND PUSH                                             │
  ├──────────────────────────────────────────────────────────────────────┤
  │                                                                       │
  │  Step 1: Aggressive Memory Cleanup                                   │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ • Stop all containers                                        │    │
  │  │ • Remove stopped containers                                  │    │
  │  │ • Remove dangling images                                     │    │
  │  │ • Remove old images (keep last 2)                            │    │
  │  │ • Remove build cache                                         │    │
  │  │ • System-wide Docker cleanup                                 │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 2: Login to ACR                                                │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ az acr login --name legalragpersonalacr                      │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 3: Build Docker Image                                          │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ docker build -t legal-rag-api:$(Build.BuildId)               │    │
  │  │                -t legal-rag-api:latest                       │    │
  │  │                                                               │    │
  │  │ FROM python:3.11-slim                                        │    │
  │  │ COPY requirements.txt .                                      │    │
  │  │ RUN pip install -r requirements.txt                          │    │
  │  │ COPY app files                                               │    │
  │  │ EXPOSE 8000                                                  │    │
  │  │ CMD ["uvicorn", "api:app"]                                   │    │
  │  │                                                               │    │
  │  │ Image Size: ~500MB (was 4.46GB)                              │    │
  │  │ Build Time: ~3-5 minutes                                     │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 4: Push Build ID Tag                                           │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ docker push legalragpersonalacr.azurecr.io/                  │    │
  │  │   legal-rag-api:20251201.10                                  │    │
  │  │                                                               │    │
  │  │ Timeout: 2 hours                                             │    │
  │  │ With progress reporting every minute                         │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 5: Push Latest Tag                                             │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ docker push legalragpersonalacr.azurecr.io/                  │    │
  │  │   legal-rag-api:latest                                       │    │
  │  │                                                               │    │
  │  │ Reuses layers from previous push (faster)                    │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 6: Cleanup                                                     │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ • Remove local images                                        │    │
  │  │ • Free memory immediately                                    │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  └──────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │  STAGE 2: DEPLOY TO AKS                                              │
  ├──────────────────────────────────────────────────────────────────────┤
  │                                                                       │
  │  Step 1: Get AKS Credentials                                         │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ az aks get-credentials                                       │    │
  │  │   --resource-group legal-rag-personal-rg                     │    │
  │  │   --name legal-rag-personal-aks                              │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 2: Update Deployment Image                                     │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ kubectl set image deployment/legal-rag-api                   │    │
  │  │   api=legalragpersonalacr.azurecr.io/                        │    │
  │  │   legal-rag-api:$(Build.BuildId)                             │    │
  │  │                                                               │    │
  │  │ Kubernetes performs rolling update:                          │    │
  │  │ 1. Start new pod with new image                              │    │
  │  │ 2. Wait for readiness probe                                  │    │
  │  │ 3. Route traffic to new pod                                  │    │
  │  │ 4. Terminate old pod                                         │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 3: Wait for Rollout                                            │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ kubectl rollout status deployment/legal-rag-api              │    │
  │  │   --timeout=10m                                              │    │
  │  │                                                               │    │
  │  │ Monitors deployment until:                                   │    │
  │  │ • New pod is running                                         │    │
  │  │ • Readiness checks pass                                      │    │
  │  │ • Old pod is terminated                                      │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 4: Verify Deployment                                           │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ kubectl get pods                                             │    │
  │  │ kubectl logs -l app=legal-rag-api                            │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  └──────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                      FRONTEND CI/CD PIPELINE                             │
│                     (azure-pipelines-frontend.yml)                       │
└─────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────────────────────────────────────────────────────┐
  │  STAGE 1: BUILD AND PUSH                                             │
  ├──────────────────────────────────────────────────────────────────────┤
  │                                                                       │
  │  Step 1: Build React Application                                     │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ npm install                                                  │    │
  │  │ npm run build                                                │    │
  │  │                                                               │    │
  │  │ Output: dist/ with optimized static files                    │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 2: Build Docker Image                                          │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ docker build -t legal-rag-frontend:$(Build.BuildId)          │    │
  │  │                -t legal-rag-frontend:latest                  │    │
  │  │                                                               │    │
  │  │ FROM nginx:alpine                                            │    │
  │  │ COPY dist/ /usr/share/nginx/html                             │    │
  │  │ COPY nginx.conf /etc/nginx/conf.d/default.conf               │    │
  │  │                                                               │    │
  │  │ Image Size: ~50MB                                            │    │
  │  │ Build Time: ~1-2 minutes                                     │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  │                            │                                          │
  │                            ▼                                          │
  │  Step 3 & 4: Push Tags                                               │
  │  ┌─────────────────────────────────────────────────────────────┐    │
  │  │ docker push legalragpersonalacr.azurecr.io/                  │    │
  │  │   legal-rag-frontend:$(Build.BuildId)                        │    │
  │  │   legal-rag-frontend:latest                                  │    │
  │  └─────────────────────────────────────────────────────────────┘    │
  └──────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
  ┌──────────────────────────────────────────────────────────────────────┐
  │  STAGE 2: DEPLOY TO AKS                                              │
  ├──────────────────────────────────────────────────────────────────────┤
  │                                                                       │
  │  Same steps as backend deployment                                    │
  │  (Get credentials, update image, wait for rollout, verify)           │
  └──────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                          DEPLOYMENT RESULT                               │
└─────────────────────────────────────────────────────────────────────────┘

                              AKS Cluster
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
             Frontend Running            Backend Running
             Image: latest              Image: 20251201.10
             Status: 1/1                Status: 1/1
                    │                           │
                    └─────────────┬─────────────┘
                                  │
                          User can access at:
                         http://52.166.46.37
```

## 3. Request Flow (User Query)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  USER ASKS: "What are requirements for broker commission?"              │
└────────────────────────────┬────────────────────────────────────────────┘
                             │
                             │ HTTP POST
                             ▼
                    ┌─────────────────┐
                    │   FRONTEND      │
                    │  52.166.46.37   │
                    │                 │
                    │  React App      │
                    └────────┬────────┘
                             │
                             │ POST /api/query
                             │ {query: "..."}
                             ▼
                    ┌─────────────────┐
                    │   BACKEND       │
                    │  20.50.147.24   │
                    │                 │
                    │  FastAPI        │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
      ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
      │  STEP 1     │  │  STEP 2     │  │  STEP 3     │
      │  Embed      │  │  Search     │  │  Generate   │
      │  Query      │  │  Pinecone   │  │  Answer     │
      └─────┬───────┘  └─────┬───────┘  └─────┬───────┘
            │                │                │
            ▼                ▼                ▼
     ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
     │   OPENAI     │ │   PINECONE   │ │  ANTHROPIC   │
     │  Embeddings  │ │  Vector DB   │ │    Claude    │
     │              │ │              │ │              │
     │  text-       │ │  Search      │ │  Generate    │
     │  embed-      │ │  top 5       │ │  answer with │
     │  3-small     │ │  similar     │ │  context     │
     │              │ │  cases       │ │              │
     │  Returns:    │ │              │ │  Returns:    │
     │  1536-dim    │ │  Returns:    │ │  - Answer    │
     │  vector      │ │  - Case IDs  │ │  - Sources   │
     │              │ │  - Scores    │ │              │
     └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
            │                │                │
            │                │                │
            │                ▼                │
            │         ┌──────────────┐        │
            │         │  Get Parent  │        │
            │         │   Context    │        │
            │         │              │        │
            │         │  Retrieve    │        │
            │         │  full case   │        │
            │         │  text        │        │
            │         └──────┬───────┘        │
            │                │                │
            └────────────────┼────────────────┘
                             │
                             │ Combine embeddings +
                             │ search results +
                             │ generated answer
                             ▼
                    ┌─────────────────┐
                    │   BACKEND       │
                    │  Format         │
                    │  Response       │
                    └────────┬────────┘
                             │
                             │ JSON Response
                             │ {
                             │   answer: "...",
                             │   sources: [...]
                             │ }
                             ▼
                    ┌─────────────────┐
                    │   FRONTEND      │
                    │  Display        │
                    │  Answer         │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  USER SEES      │
                    │  ANSWER WITH    │
                    │  CITATIONS      │
                    └─────────────────┘

  Timeline:
  ─────────────────────────────────────────────────────────────
  0ms      200ms    500ms        3s              6s
  │         │        │           │               │
  User      Embed    Search      Generate        Display
  submits   query    Pinecone    with Claude     result
```

## 4. Data Indexing Pipeline (One-time / Manual)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        RAW LEGAL CASES (AWS S3)                          │
│                                                                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐         1,571 PDF files      │
│  │ Case 001 │  │ Case 002 │  │  ...     │                               │
│  │  .pdf    │  │  .pdf    │  │ Case     │                               │
│  └──────────┘  └──────────┘  │ 1571.pdf │                               │
│                               └──────────┘                               │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  │ Download and parse
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        CHUNKING PROCESS                                  │
│                       (ingest_pipeline.py)                               │
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  For each legal case PDF:                                         │  │
│  │                                                                    │  │
│  │  1. Extract text                                                  │  │
│  │  2. Split into parent chunks (semantic boundaries)                │  │
│  │  3. Split each parent into child chunks (smaller units)           │  │
│  │                                                                    │  │
│  │  Parent Chunk (full section):                                     │  │
│  │  ┌──────────────────────────────────────────────┐                 │  │
│  │  │ "In Smith v. Jones (2023), the court held    │                 │  │
│  │  │  that brokers must demonstrate three key     │                 │  │
│  │  │  requirements to earn commission: 1) valid   │                 │  │
│  │  │  license, 2) written agreement, 3) direct    │                 │  │
│  │  │  involvement in transaction..."              │                 │  │
│  │  └──────────────────────────────────────────────┘                 │  │
│  │                       │                                            │  │
│  │                       ├─► Child Chunk 1:                           │  │
│  │                       │   "In Smith v. Jones (2023), the court..."│  │
│  │                       │                                            │  │
│  │                       ├─► Child Chunk 2:                           │  │
│  │                       │   "...brokers must demonstrate three..."  │  │
│  │                       │                                            │  │
│  │                       └─► Child Chunk 3:                           │  │
│  │                           "...1) valid license, 2) written..."    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  │ Save to disk
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         CHUNKED OUTPUT                                   │
│                                                                           │
│  chunked_output/                                                         │
│  ├── children.json    (9,594 child chunks)                               │
│  └── parents.json     (1,671 parent chunks)                              │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  │ Load and embed
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        EMBEDDING GENERATION                              │
│                       (embed_and_index.py)                               │
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  For each child chunk (9,594 total):                              │  │
│  │                                                                    │  │
│  │  Text: "In Smith v. Jones (2023), the court held that..."         │  │
│  │    │                                                               │  │
│  │    ▼                                                               │  │
│  │  ┌─────────────────────────────────────────────────┐              │  │
│  │  │         OPENAI EMBEDDINGS API                   │              │  │
│  │  │      model: text-embedding-3-small              │              │  │
│  │  └────────────────────┬────────────────────────────┘              │  │
│  │                       │                                            │  │
│  │                       ▼                                            │  │
│  │  Vector (1536 dimensions):                                        │  │
│  │  [0.012, -0.034, 0.156, ..., 0.089]                               │  │
│  │                                                                    │  │
│  │  Process in batches of 100 with retry logic:                      │  │
│  │  ┌──────────────────────────────────────────────┐                 │  │
│  │  │ Batch 1-100   → Embed → [vectors]            │                 │  │
│  │  │ Batch 101-200 → Embed → [vectors]            │                 │  │
│  │  │ ...                                           │                 │  │
│  │  │ Batch 9501-9594 → Embed → [vectors]          │                 │  │
│  │  └──────────────────────────────────────────────┘                 │  │
│  │                                                                    │  │
│  │  With exponential backoff for rate limits:                        │  │
│  │  1s → 2s → 4s → 8s → 16s                                          │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  │ Upload to Pinecone
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        PINECONE INDEXING                                 │
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  Create index "legal-cases"                                       │  │
│  │  - Dimension: 1536                                                │  │
│  │  - Metric: cosine                                                 │  │
│  │                                                                    │  │
│  │  Upsert vectors in batches of 100:                                │  │
│  │  ┌──────────────────────────────────────────────┐                 │  │
│  │  │ {                                            │                 │  │
│  │  │   id: "case_001_chunk_001",                  │                 │  │
│  │  │   values: [0.012, -0.034, ...],  // 1536d    │                 │  │
│  │  │   metadata: {                                │                 │  │
│  │  │     case_id: "8118004",                      │                 │  │
│  │  │     parent_id: "parent_001",                 │                 │  │
│  │  │     text: "In Smith v. Jones...",            │                 │  │
│  │  │     case_name: "Smith v. Jones"              │                 │  │
│  │  │   }                                          │                 │  │
│  │  │ }                                            │                 │  │
│  │  └──────────────────────────────────────────────┘                 │  │
│  │                                                                    │  │
│  │  Total: 9,594 vectors indexed                                     │  │
│  │  Time: ~10-15 minutes                                             │  │
│  │  Cost: ~$0.04 (one-time)                                          │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │   INDEXING COMPLETE     │
                    │                         │
                    │   Ready for queries!    │
                    └─────────────────────────┘
```

## 5. Kubernetes Pod Lifecycle

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    NEW CODE PUSHED TO GIT                                │
└────────────────────────────┬────────────────────────────────────────────┘
                             │
                             │ Trigger
                             ▼
                    ┌─────────────────┐
                    │  CI/CD Pipeline │
                    │  Builds Image   │
                    └────────┬────────┘
                             │
                             │ Push to ACR
                             ▼
                    ┌─────────────────┐
                    │  Azure Container│
                    │   Registry      │
                    │                 │
                    │  New image:     │
                    │  legal-rag-api: │
                    │  20251201.10    │
                    └────────┬────────┘
                             │
                             │ kubectl set image
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     KUBERNETES ROLLING UPDATE                            │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ BEFORE UPDATE                                                    │    │
│  │ ┌──────────────────────────────────────────────────────────────┐│    │
│  │ │  Pod: legal-rag-api-OLD                                      ││    │
│  │ │  ┌────────────┐                                              ││    │
│  │ │  │  RUNNING   │  Serving traffic                             ││    │
│  │ │  │  1/1       │  Image: legal-rag-api:17                     ││    │
│  │ │  └────────────┘                                              ││    │
│  │ └──────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                             │                                            │
│                             │ Update triggered                           │
│                             ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ STEP 1: Create new pod                                          │    │
│  │ ┌──────────────────────────────────────────────────────────────┐│    │
│  │ │  Pod: legal-rag-api-OLD          Pod: legal-rag-api-NEW      ││    │
│  │ │  ┌────────────┐                  ┌────────────┐              ││    │
│  │ │  │  RUNNING   │                  │ PENDING    │              ││    │
│  │ │  │  1/1       │ Serving traffic  │ 0/1        │ Pulling image││    │
│  │ │  │  :17       │                  │ :20251201  │              ││    │
│  │ │  └────────────┘                  └────────────┘              ││    │
│  │ └──────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                             │                                            │
│                             │ Image pulled                               │
│                             ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ STEP 2: Starting container                                      │    │
│  │ ┌──────────────────────────────────────────────────────────────┐│    │
│  │ │  Pod: legal-rag-api-OLD          Pod: legal-rag-api-NEW      ││    │
│  │ │  ┌────────────┐                  ┌────────────┐              ││    │
│  │ │  │  RUNNING   │                  │ RUNNING    │              ││    │
│  │ │  │  1/1       │ Serving traffic  │ 0/1        │ Starting...  ││    │
│  │ │  │  :17       │                  │ :20251201  │              ││    │
│  │ │  └────────────┘                  └────────────┘              ││    │
│  │ └──────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                             │                                            │
│                             │ Readiness probe checks                     │
│                             │ GET /docs → 200 OK                         │
│                             ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ STEP 3: New pod ready                                           │    │
│  │ ┌──────────────────────────────────────────────────────────────┐│    │
│  │ │  Pod: legal-rag-api-OLD          Pod: legal-rag-api-NEW      ││    │
│  │ │  ┌────────────┐                  ┌────────────┐              ││    │
│  │ │  │  RUNNING   │                  │  RUNNING   │              ││    │
│  │ │  │  1/1       │ Serving traffic  │  1/1       │ READY!       ││    │
│  │ │  │  :17       │                  │ :20251201  │              ││    │
│  │ │  └────────────┘                  └────────────┘              ││    │
│  │ └──────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                             │                                            │
│                             │ Switch traffic                             │
│                             ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ STEP 4: Traffic switched to new pod                             │    │
│  │ ┌──────────────────────────────────────────────────────────────┐│    │
│  │ │  Pod: legal-rag-api-OLD          Pod: legal-rag-api-NEW      ││    │
│  │ │  ┌────────────┐                  ┌────────────┐              ││    │
│  │ │  │  RUNNING   │                  │  RUNNING   │              ││    │
│  │ │  │  1/1       │                  │  1/1       │ Serving      ││    │
│  │ │  │  :17       │ Draining...      │ :20251201  │ traffic      ││    │
│  │ │  └────────────┘                  └────────────┘              ││    │
│  │ └──────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                             │                                            │
│                             │ Terminate old pod                          │
│                             ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ AFTER UPDATE                                                     │    │
│  │ ┌──────────────────────────────────────────────────────────────┐│    │
│  │ │  Pod: legal-rag-api-NEW                                      ││    │
│  │ │  ┌────────────┐                                              ││    │
│  │ │  │  RUNNING   │  Serving traffic                             ││    │
│  │ │  │  1/1       │  Image: legal-rag-api:20251201.10            ││    │
│  │ │  └────────────┘                                              ││    │
│  │ └──────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│  Total Update Time: ~30-60 seconds                                       │
│  Zero Downtime: Old pod serves until new pod is ready                    │
└─────────────────────────────────────────────────────────────────────────┘
```

## 6. Azure Resources Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      AZURE SUBSCRIPTION                                  │
│                     "Azure subscription 1"                               │
└────────────────────────────┬────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   RESOURCE GROUP                                         │
│                legal-rag-personal-rg                                     │
│                 Location: East US                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  AZURE KUBERNETES SERVICE (AKS)                                  │   │
│  │  Name: legal-rag-personal-aks                                    │   │
│  │  ┌────────────────────────────────────────────────────────────┐  │   │
│  │  │  Node Pool                                                  │  │   │
│  │  │  - VM Size: Standard_DS2_v2                                 │  │   │
│  │  │  - Node Count: 1                                            │  │   │
│  │  │  - OS: Ubuntu                                               │  │   │
│  │  │  - CPU: 2 vCPUs                                             │  │   │
│  │  │  - Memory: 7 GB                                             │  │   │
│  │  └────────────────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────────────────┐  │   │
│  │  │  Workloads                                                  │  │   │
│  │  │  - legal-rag-api (Backend)                                  │  │   │
│  │  │  - legal-rag-frontend (Frontend)                            │  │   │
│  │  └────────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  AZURE CONTAINER REGISTRY (ACR)                                 │   │
│  │  Name: legalragpersonalacr                                       │   │
│  │  ┌────────────────────────────────────────────────────────────┐  │   │
│  │  │  Repositories                                               │  │   │
│  │  │  - legal-rag-api                                            │  │   │
│  │  │    └─ Tags: latest, 20251201.9, 20251201.10, ...           │  │   │
│  │  │  - legal-rag-frontend                                       │  │   │
│  │  │    └─ Tags: latest, 15, 16, ...                             │  │   │
│  │  └────────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  LOAD BALANCERS (Auto-created by AKS)                           │   │
│  │  ┌────────────────────────────────────────────────────────────┐  │   │
│  │  │  Frontend LB                                                │  │   │
│  │  │  Public IP: 52.166.46.37                                    │  │   │
│  │  │  Port: 80 → Pod:80                                          │  │   │
│  │  └────────────────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────────────────┐  │   │
│  │  │  Backend LB                                                 │  │   │
│  │  │  Public IP: 20.50.147.24                                    │  │   │
│  │  │  Port: 80 → Pod:8000                                        │  │   │
│  │  └────────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  AZURE DEVOPS (EXTERNAL)                                        │   │
│  │  Organization: grigas07                                          │   │
│  │  Project: legal-rag-personal                                     │   │
│  │  ┌────────────────────────────────────────────────────────────┐  │   │
│  │  │  Pipelines                                                  │  │   │
│  │  │  - legal-rag-personal (Backend)                             │  │   │
│  │  │  - legal-rag-frontend (Frontend)                            │  │   │
│  │  └────────────────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────────────────┐  │   │
│  │  │  Self-Hosted Agent Pool                                     │  │   │
│  │  │  - Name: Default                                            │  │   │
│  │  │  - OS: Windows                                              │  │   │
│  │  │  - Used for: Docker builds                                  │  │   │
│  │  └────────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘

External Services (Not in Azure):
┌─────────────────────────────────────────────────────────────────────────┐
│  AWS S3         │  Pinecone      │  OpenAI        │  Anthropic          │
│  PDF Storage    │  Vector DB     │  Embeddings    │  Claude LLM         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Summary

This Legal RAG system uses a modern MLOps architecture with:

- **Containerized microservices** (Frontend + Backend)
- **Automated CI/CD** with Azure DevOps pipelines
- **Zero-downtime deployments** using Kubernetes rolling updates
- **Managed services** for vector DB (Pinecone) and LLMs (OpenAI, Anthropic)
- **Scalable infrastructure** on Azure Kubernetes Service
- **Version-controlled** deployments with image tagging

The system processes legal case documents through an embedding pipeline, stores them in Pinecone, and provides an interactive query interface powered by Claude AI.
