trigger:
  branches:
    include:
    - main
    - master
  paths:
    include:
    - api.py
    - query_rag.py
    - config.py
    - pdf_generator.py
    - requirements.txt
    - Dockerfile
    - chunked_output/**
    - case_id_to_s3_mapping.json
    - azure-pipelines-backend.yml

variables:
  acrName: 'legalragpersonalacr'
  imageName: 'legal-rag-api'
  resourceGroup: 'legal-rag-personal-rg'
  aksCluster: 'legal-rag-personal-aks'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  azureSubscription: 'Azure-Personal-SC'  # Service connection name - you'll create this

pool:
  name: 'Default'

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildJob
    displayName: 'Build and Push Image'
    timeoutInMinutes: 180  # 3 hours timeout
    steps:
    - task: PowerShell@2
      displayName: 'Clean Docker Cache'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "Cleaning Docker cache to free memory..."
          docker system prune -f
          Write-Host "Docker cleanup complete"

    - task: AzureCLI@2
      displayName: 'Login to ACR'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          chcp 65001
          az acr login --name $(acrName)

    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: 'build'
        Dockerfile: '$(dockerfilePath)'
        tags: |
          $(Build.BuildId)
          latest
        arguments: '-t $(acrName).azurecr.io/$(imageName):$(Build.BuildId) -t $(acrName).azurecr.io/$(imageName):latest'

    - task: AzureCLI@2
      displayName: 'Push Build ID Tag to ACR'
      timeoutInMinutes: 120  # 2 hours for push
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $ErrorActionPreference = "Continue"

          Write-Host "Starting push of tag $(Build.BuildId)..."
          Write-Host "This may take a long time for large images. Please be patient."

          # Push with timeout handling
          $job = Start-Job -ScriptBlock {
            docker push legalragpersonalacr.azurecr.io/legal-rag-api:$using:env:BUILD_BUILDID 2>&1
          }

          $timeout = 7200  # 2 hours in seconds
          $elapsed = 0
          $reportInterval = 60  # Report every minute

          while ($job.State -eq 'Running' -and $elapsed -lt $timeout) {
            Start-Sleep -Seconds $reportInterval
            $elapsed += $reportInterval
            $minutes = [math]::Round($elapsed / 60, 1)
            Write-Host "Still pushing... ($minutes minutes elapsed)"
          }

          if ($job.State -eq 'Running') {
            Stop-Job $job
            Remove-Job $job
            throw "Push timed out after $($timeout/60) minutes"
          }

          $result = Receive-Job $job
          Remove-Job $job

          Write-Host $result
          Write-Host "Successfully pushed tag $(Build.BuildId)"

    - task: AzureCLI@2
      displayName: 'Push Latest Tag to ACR'
      timeoutInMinutes: 30  # Latest should be faster since layers exist
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          Write-Host "Pushing latest tag (reusing layers from previous push)..."
          docker push $(acrName).azurecr.io/$(imageName):latest

- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployJob
    displayName: 'Deploy to AKS'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy to AKS'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Get AKS credentials
                az aks get-credentials `
                  --resource-group $(resourceGroup) `
                  --name $(aksCluster) `
                  --overwrite-existing

                # Update deployment image
                kubectl set image deployment/legal-rag-api `
                  api=$(acrName).azurecr.io/$(imageName):$(Build.BuildId)

                # Wait for rollout to complete
                kubectl rollout status deployment/legal-rag-api --timeout=5m

                # Show pod status
                kubectl get pods -l app=legal-rag-api
