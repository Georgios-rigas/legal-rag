trigger:
  branches:
    include:
    - main
    - master
  paths:
    include:
    - api.py
    - query_rag.py
    - config.py
    - pdf_generator.py
    - requirements.txt
    - Dockerfile
    - chunked_output/**
    - case_id_to_s3_mapping.json
    - azure-pipelines-backend.yml

variables:
  acrName: 'legalragpersonalacr'
  imageName: 'legal-rag-api'
  resourceGroup: 'legal-rag-personal-rg'
  aksCluster: 'legal-rag-personal-aks'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  azureSubscription: 'Azure-Personal-SC'  # Service connection name - you'll create this

pool:
  name: 'Default'

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildJob
    displayName: 'Build and Push Image'
    timeoutInMinutes: 180  # 3 hours timeout
    steps:
    - task: AzureCLI@2
      displayName: 'Login to ACR'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          chcp 65001
          az acr login --name $(acrName)

    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: 'build'
        Dockerfile: '$(dockerfilePath)'
        tags: |
          $(Build.BuildId)
          latest
        arguments: '-t $(acrName).azurecr.io/$(imageName):$(Build.BuildId) -t $(acrName).azurecr.io/$(imageName):latest'

    - task: AzureCLI@2
      displayName: 'Push to ACR'
      timeoutInMinutes: 120  # 2 hours for push
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $ErrorActionPreference = "Stop"

          # Push with retry logic
          $maxRetries = 3
          $retryCount = 0
          $success = $false

          while (-not $success -and $retryCount -lt $maxRetries) {
            try {
              Write-Host "Attempt $($retryCount + 1) of $maxRetries..."
              docker push $(acrName).azurecr.io/$(imageName):$(Build.BuildId)
              $success = $true
              Write-Host "Successfully pushed tag $(Build.BuildId)"
            } catch {
              $retryCount++
              if ($retryCount -lt $maxRetries) {
                Write-Host "Push failed, retrying in 10 seconds..."
                Start-Sleep -Seconds 10
              } else {
                throw "Failed to push after $maxRetries attempts"
              }
            }
          }

          # Push latest tag (reuses layers from previous push)
          docker push $(acrName).azurecr.io/$(imageName):latest

- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployJob
    displayName: 'Deploy to AKS'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy to AKS'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Get AKS credentials
                az aks get-credentials `
                  --resource-group $(resourceGroup) `
                  --name $(aksCluster) `
                  --overwrite-existing

                # Update deployment image
                kubectl set image deployment/legal-rag-api `
                  api=$(acrName).azurecr.io/$(imageName):$(Build.BuildId)

                # Wait for rollout to complete
                kubectl rollout status deployment/legal-rag-api --timeout=5m

                # Show pod status
                kubectl get pods -l app=legal-rag-api
