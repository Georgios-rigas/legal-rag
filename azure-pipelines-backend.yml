# Azure DevOps CI/CD Pipeline for Legal RAG Backend API

trigger:
  branches:
    include:
    - master
    - main
  paths:
    include:
    - api.py
    - query_rag.py
    - config.py
    - pdf_generator.py
    - requirements.txt
    - Dockerfile
    - chunked_output/*
    - case_id_to_s3_mapping.json

pool:
  vmImage: 'ubuntu-latest'

variables:
  acrName: 'legalragacr'
  imageName: 'legal-rag-api'
  resourceGroup: 'legal-rag-rg'
  aksCluster: 'legal-rag-aks'

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildJob
    displayName: 'Build Docker Image with ACR'
    steps:
    - task: AzureCLI@2
      displayName: 'Build and Push to ACR'
      inputs:
        azureSubscription: 'Azure-Connection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az acr build --registry $(acrName) \
            --image $(imageName):$(Build.BuildId) \
            --image $(imageName):latest \
            --file Dockerfile \
            .

- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployJob
    displayName: 'Deploy to Kubernetes'
    steps:
    - task: AzureCLI@2
      displayName: 'Update AKS Deployment'
      inputs:
        azureSubscription: 'Azure-Connection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Get AKS credentials
          az aks get-credentials --resource-group $(resourceGroup) --name $(aksCluster) --overwrite-existing

          # Update the deployment image
          kubectl set image deployment/legal-rag-api api=$(acrName).azurecr.io/$(imageName):$(Build.BuildId)

          # Wait for rollout to complete
          kubectl rollout status deployment/legal-rag-api
